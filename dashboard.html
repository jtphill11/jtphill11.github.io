<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullride | Dashboard</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      color: #fff;
      overflow-x: hidden;
      line-height: 1.6;
      transition: background 0.4s ease, color 0.4s ease;
    }

    a { color: white; text-decoration: none; transition: 0.3s ease; }
    a:hover { color: #999; }

    /* Sidebar */
    .sidebar {
      position: fixed; top: 0; left: 0;
      width: 260px; height: 100vh;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex; flex-direction: column; align-items: center;
      padding: 2rem 1rem;
      transition: transform 0.4s ease;
      z-index: 200;
    }
    .sidebar.hidden { transform: translateX(-100%); }

    .sidebar img { width: 140px; margin-bottom: 2rem; filter: brightness(1.5); }
    .sidebar .button {
      background: none; border: 1px solid #fff; color: #fff;
      width: 100%; padding: 0.8rem; margin-bottom: 1rem;
      border-radius: 8px; text-align: center; cursor: pointer;
      transition: all 0.3s ease;
    }
    .sidebar .button:hover { background: #fff; color: #000; }

    .toggle-btn { position: fixed; top: 25px; left: 20px; background: #fff;
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 300;
    }
    .toggle-dot { width: 10px; height: 10px; background: #000; border-radius: 50%; }

    .profile { position: fixed; top: 20px; right: 70px; width: 45px; height: 45px;
      border-radius: 50%; background: #fff; color: #000;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; cursor: pointer; z-index: 300;
    }

    .profile-menu {
      position: absolute; top: 70px; right: 30px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px; backdrop-filter: blur(12px);
      display: none; flex-direction: column; width: 180px;
    }
    .profile-menu.active { display: flex; }
    .profile-menu button { background: none; border: none; color: #fff;
      padding: 0.9rem; text-align: left; cursor: pointer;
    }
    .profile-menu button:hover { background: rgba(255,255,255,0.15); }

    main { margin-left: 280px; padding: 4rem 3rem; transition: margin-left 0.4s ease; }
    .sidebar.hidden ~ main { margin-left: 0; }

    h1 { font-size: 2.8rem; font-weight: 600; margin-bottom: 1rem; }
    .lead { font-size: 1.2rem; color: #aaa; margin-bottom: 2rem; }

    /* STOCK GRID */
    .stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 1.5rem;
    }

    .stock-card {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .stock-card.selected { border: 2px solid lime; background: rgba(0,255,0,0.1); }
    .stock-card:hover { transform: translateY(-3px); }

    canvas { width: 100%; height: 120px; margin-top: 0.5rem; }

    button.primary {
      padding: 0.8rem 1.5rem;
      background: #fff;
      border: none;
      color: #000;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1.5rem;
    }
    button.primary:hover { transform: translateY(-2px); }

    body.light-mode { background: #fff; color: #000; }
    body.light-mode .sidebar { background: rgba(0,0,0,0.05); }
    body.light-mode .stock-card { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); }
    body.light-mode .stock-card.selected { border-color: green; background: rgba(0,128,0,0.1); }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <aside class="sidebar" id="sidebar">
    <img src="assets/bullride1055_v2.png" alt="Bullride Logo">
    <button class="button" id="dashboardBtn">Dashboard</button>
    <button class="button" id="creationsBtn">My Creations</button>
    <button class="button" id="investmentsBtn">My Investments</button>
    <button class="button" id="exploreBtn">Explore</button>
    <button class="button" id="adminBtn" style="display:none;">Admin Panel</button>
  </aside>

  <div class="toggle-btn" id="toggleSidebar"><div class="toggle-dot"></div></div>
  <div class="profile" id="profileIcon">U</div>
  <div class="profile-menu" id="profileMenu">
    <button id="settingsBtn">Settings</button>
    <button id="signOut">Sign Out</button>
  </div>

  <main id="mainContent">
    <h1>Dashboard</h1>
    <p class="lead">Explore and manage your investments — your personalized ETF hub.</p>
  </main>

  <script type="module">
    import { UserManager } from "https://cdn.jsdelivr.net/npm/oidc-client-ts@2.2.3/+esm";
    const API_BASE = "https://api.bullride.us";
    const userManager = new UserManager({
      authority: "https://cognito-idp.us-east-1.amazonaws.com/us-east-1_HPx82G5s7",
      client_id: "2l15ru0njbo72tv2skuceokjf2",
      redirect_uri: "https://bullride.us/dashboard",
      response_type: "code",
      scope: "openid email phone profile"
    });

    // Login session check
    (async () => {
      if (window.location.search.includes("code=")) {
        await userManager.signinRedirectCallback();
        window.history.replaceState({}, document.title, "/dashboard");
      }
      const user = await userManager.getUser();
      if (!user || user.expired) {
        window.location.href = "https://bullride.us";
        return;
      }
      init(user);
    })();

    async function init(user) {
      const main = document.getElementById("mainContent");
      const profileIcon = document.getElementById("profileIcon");
      const profileMenu = document.getElementById("profileMenu");
      const sidebar = document.getElementById("sidebar");
      const toggleSidebar = document.getElementById("toggleSidebar");

      // initials
      const name = user.profile.name || user.profile.email;
      profileIcon.textContent = name[0].toUpperCase();

      toggleSidebar.addEventListener("click",()=>sidebar.classList.toggle("hidden"));
      profileIcon.addEventListener("click",()=>profileMenu.classList.toggle("active"));
      document.addEventListener("click",(e)=>{if(!profileMenu.contains(e.target)&&!profileIcon.contains(e.target))profileMenu.classList.remove("active")});

      document.getElementById("signOut").addEventListener("click",async()=>{
        await userManager.removeUser();
        window.location.href="https://auth.bullride.us/logout?client_id=2l15ru0njbo72tv2skuceokjf2&logout_uri=https://bullride.us";
      });

      document.getElementById("creationsBtn").onclick = ()=>loadMyCreations(user);
      document.getElementById("exploreBtn").onclick = ()=>loadExplore();
    }

    // ---------------- My Creations -----------------
    async function loadMyCreations(user){
      const main=document.getElementById("mainContent");
      main.innerHTML=`<h1>My Creations</h1><p class="lead">Your custom ETF baskets.</p>
      <div id="myBaskets"></div>
      <button class="primary" id="createBasketBtn">+ Create New Basket</button>`;
      const div=document.getElementById("myBaskets");
      const email=user.profile.email;
      const res=await fetch(\`\${API_BASE}/api/baskets/user?email=\${encodeURIComponent(email)}\`);
      const baskets=await res.json();
      if(baskets.length===0){div.innerHTML="<p>No baskets yet.</p>";return;}
      baskets.forEach(b=>{
        const card=document.createElement("div");
        card.className="stock-card";
        card.innerHTML=\`<h3>\${b.name} \${b.active===false?"(inactive)":""}</h3>
        <p>\${b.stocks.length} stocks</p>
        <button class="primary delete-btn">Delete</button>\`;
        card.querySelector(".delete-btn").onclick=async()=>{
          if(confirm("Delete this basket?")){
            await fetch(\`\${API_BASE}/api/baskets/\${b.basketId}\`,{method:"DELETE"});
            loadMyCreations(user);
          }
        };
        div.appendChild(card);
      });
      document.getElementById("createBasketBtn").onclick=()=>openBasketBuilder(user);
    }

    // ---------------- Basket Builder -----------------
    async function openBasketBuilder(user){
      const main=document.getElementById("mainContent");
      main.innerHTML=\`
        <h1>Create Basket</h1>
        <p class="lead">Select stocks to include in your basket. You can search or choose popular ones.</p>
        <input id="basketName" placeholder="Basket Name" style="padding:0.6rem;width:250px;margin-bottom:1rem;border-radius:6px;border:none;">
        <input id="stockSearch" placeholder="Search stock..." style="padding:0.6rem;width:250px;margin-left:1rem;border-radius:6px;border:none;">
        <button class="primary" id="searchBtn">Search</button>
        <div id="stocksContainer" class="stock-grid" style="margin-top:2rem;">Loading popular stocks...</div>
        <div id="basketPreview" style="margin-top:2rem;"></div>
        <button class="primary" id="finalizeBtn" style="display:none;">Finalize Basket</button>
      \`;
      const container=document.getElementById("stocksContainer");
      let selected={};
      const userEmail=user.profile.email;

      async function loadPopular(){
        const res=await fetch(\`\${API_BASE}/api/alpaca/popular\`);
        const data=await res.json();
        renderStocks(data);
      }

      async function searchStock(){
        const q=document.getElementById("stockSearch").value.trim();
        if(!q)return loadPopular();
        const res=await fetch(\`\${API_BASE}/api/alpaca/search?q=\${encodeURIComponent(q)}\`);
        const data=await res.json();
        renderStocks(data);
      }

      function renderStocks(list){
        container.innerHTML="";
        list.forEach(async s=>{
          const card=document.createElement("div");
          card.className="stock-card";
          card.innerHTML=\`<h4>\${s.symbol}</h4><p>Bid: \$\${s.quote?.bp||"—"}</p><canvas id="chart-\${s.symbol}"></canvas>\`;
          card.onclick=()=>{
            if(selected[s.symbol]){delete selected[s.symbol];card.classList.remove("selected");}
            else{selected[s.symbol]={symbol:s.symbol,shares:1,price:s.quote?.bp||0};card.classList.add("selected");}
            updatePreview();
          };
          container.appendChild(card);

          // draw mini chart
          const bars=await fetch(\`\${API_BASE}/api/alpaca/bars?symbols=\${s.symbol}&limit=20\`).then(r=>r.json());
          const ctx=card.querySelector("canvas").getContext("2d");
          const dataBars=bars.bars?.[s.symbol]||[];
          new Chart(ctx,{type:'line',data:{
            labels:dataBars.map(b=>b.t.slice(5,10)),
            datasets:[{data:dataBars.map(b=>b.c),borderColor:'#0f0',fill:false,tension:0.3}]
          },options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});
        });
      }

      function updatePreview(){
        const preview=document.getElementById("basketPreview");
        const keys=Object.keys(selected);
        if(keys.length===0){preview.innerHTML="";document.getElementById("finalizeBtn").style.display="none";return;}
        let html="<h3>Basket Preview</h3><ul>";
        keys.forEach(sym=>{
          html+=\`<li>\${sym}: <input type='number' min='1' value='\${selected[sym].shares}' style='width:60px' id='shares-\${sym}'> shares</li>\`;
        });
        html+="</ul>";
        preview.innerHTML=html;
        document.getElementById("finalizeBtn").style.display="inline-block";
        keys.forEach(sym=>{
          document.getElementById(\`shares-\${sym}\`).onchange=(e)=>selected[sym].shares=parseInt(e.target.value);
        });
      }

      document.getElementById("searchBtn").onclick=searchStock;
      loadPopular();

      document.getElementById("finalizeBtn").onclick=async()=>{
        const name=document.getElementById("basketName").value.trim()||"Untitled Basket";
        const stocks=Object.values(selected);
        if(stocks.length===0){alert("Select at least one stock.");return;}
        const payload={userEmail,name,stocks};
        await fetch(\`\${API_BASE}/api/baskets/create\`,{
          method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)
        });
        alert("Basket created!");
        loadMyCreations(user);
      };
    }

    // ---------------- Explore -----------------
    async function loadExplore(){
      const main=document.getElementById("mainContent");
      main.innerHTML=\`<h1>Explore</h1><p class="lead">Trending baskets across all users.</p><div id="exploreGrid" class="stock-grid"></div>\`;
      const grid=document.getElementById("exploreGrid");
      const res=await fetch(\`\${API_BASE}/api/baskets/explore\`);
      const data=await res.json();
      grid.innerHTML="";
      data.filter(b=>b.active!==false).forEach(b=>{
        const card=document.createElement("div");
        card.className="stock-card";
        card.innerHTML=\`<h3>\${b.name}</h3><p>\${b.stocks.length} stocks</p><p>By \${b.userEmail}</p>\`;
        grid.appendChild(card);
      });
    }
  </script>
</body>
</html>
