<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullride | Dashboard</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      color: #fff;
      overflow-x: hidden;
      line-height: 1.6;
      transition: background 0.4s ease, color 0.4s ease;
    }

    a { color: white; text-decoration: none; transition: 0.3s ease; }
    a:hover { color: #999; }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 260px;
      height: 100vh;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      transform: translateX(0);
      transition: transform 0.4s ease, background 0.4s ease, border 0.4s ease;
      z-index: 200;
    }

    .sidebar.hidden { transform: translateX(-100%); }

    .sidebar img {
      width: 140px;
      margin-bottom: 2rem;
      filter: brightness(1.5);
      transition: filter 0.4s ease;
    }

    .sidebar .button {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      text-align: center;
    }

    .sidebar .button:hover {
      background: #fff;
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 0 10px #fff;
    }

    /* Toggle Button */
    .toggle-btn {
      position: fixed;
      top: 25px;
      left: 20px;
      background: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 300;
      transition: transform 0.3s ease, background 0.3s ease;
    }

    .toggle-btn:hover { transform: scale(1.1); }

    .toggle-dot {
      width: 10px;
      height: 10px;
      background: #000;
      border-radius: 50%;
      transition: transform 0.3s ease, background 0.3s ease;
    }

    /* Profile icon */
    .profile {
      position: fixed;
      top: 20px;
      right: 70px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #fff;
      color: #000;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      z-index: 300;
      transition: transform 0.3s ease, background 0.4s ease, color 0.4s ease;
    }

    .profile:hover { transform: scale(1.05); }

    /* Theme icon toggle (sun/moon) */
    .theme-toggle {
      position: fixed;
      top: 22px;
      right: 25px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: none;
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
      z-index: 310;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.1);
    }

    .theme-toggle svg {
      width: 22px;
      height: 22px;
      fill: #fff;
      transition: fill 0.4s ease;
    }

    body.light-mode .theme-toggle svg {
      fill: #000;
    }

    /* Profile dropdown */
    .profile-menu {
      position: absolute;
      top: 70px;
      right: 30px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      backdrop-filter: blur(12px);
      overflow: hidden;
      display: none;
      flex-direction: column;
      width: 180px;
      animation: fadeIn 0.3s ease forwards;
      z-index: 400;
      transition: background 0.4s ease, border 0.4s ease;
    }

    .profile-menu.active { display: flex; }

    .profile-menu button {
      background: none;
      border: none;
      color: #fff;
      padding: 0.9rem;
      text-align: left;
      width: 100%;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .profile-menu button:hover { background: rgba(255,255,255,0.15); }

    /* Main content */
    main {
      margin-left: 280px;
      padding: 4rem 3rem;
      transition: margin-left 0.4s ease, background 0.4s ease, color 0.4s ease;
    }

    .sidebar.hidden ~ main { margin-left: 0; }

    h1 {
      font-size: 2.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .lead {
      font-size: 1.2rem;
      color: #aaa;
      max-width: 700px;
      margin-bottom: 3rem;
    }

    /* Grid Squares */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 2rem;
      margin-bottom: 4rem;
    }

    /* Force up to 4 columns max, cards keep consistent size */
/* --- FIXED GRID LAYOUT (Always up to 4 columns, never stretches) --- */
    .grid,
    #basketsGrid,
    #investmentsGrid,
    #exploreGrid,
    #stocksGrid {
      display: grid;
      grid-template-columns: repeat(4, 260px); /* Fixed width for each card */
      grid-auto-rows: 260px;                   /* Fixed height */
      gap: 1.6rem;
      justify-content: start;                  /* left align content */
      align-content: start;                    /* top align grid rows */
      align-items: start;
      justify-items: start;
      width: fit-content;                      /* ensures grid only takes up needed width */
      margin: 0;                               /* removes auto centering */
      padding: 0;
    }

    /* Make it responsive for smaller screens */
    @media (max-width: 1200px) {
      .grid,
      #basketsGrid,
      #investmentsGrid,
      #exploreGrid,
      #stocksGrid {
        grid-template-columns: repeat(3, 260px);
      }
    }

    @media (max-width: 900px) {
      .grid,
      #basketsGrid,
      #investmentsGrid,
      #exploreGrid,
      #stocksGrid {
        grid-template-columns: repeat(2, 260px);
      }
    }

    @media (max-width: 600px) {
      .grid,
      #basketsGrid,
      #investmentsGrid,
      #exploreGrid,
      #stocksGrid {
        grid-template-columns: repeat(1, 260px);
      }
    }

    /* Individual card styling stays compact */
    .grid > div,
    #basketsGrid > div,
    #investmentsGrid > div,
    #exploreGrid > div,
    #stocksGrid > div {
      width: 260px;
      justify-self: start;
    }


    .cell {
      text-align: center;
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0.9;
    }

    .cell:hover {
      transform: translateY(-5px);
      opacity: 1;
    }

    .square {
      width: 75px;
      height: 75px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 3px;
      background: none;
      margin: 0 auto 1rem;
      animation: rotateSquare 10s linear infinite;
      transform-origin: center;
      cursor: pointer;
      transition: transform 0.4s ease, box-shadow 0.4s ease, gap 0.4s ease;
    }

    .square div {
      background: #fff;
      border-radius: 2px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .square:hover {
      transform: scale(1.25);
      gap: 6px;
      box-shadow: 0 0 25px rgba(255,255,255,0.6);
    }

    @keyframes rotateSquare {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* MOBILE */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 260px; }
      .sidebar.active { transform: translateX(0); }
      main { margin-left: 0; padding: 2rem; }
      .toggle-btn { top: 15px; left: 15px; }
    }

    /* LIGHT MODE */
    body.light-mode {
      background-color: #fff;
      color: #000;
    }

    body.light-mode .sidebar {
      background: rgba(0,0,0,0.05);
      border-right: 1px solid rgba(0,0,0,0.1);
    }

    body.light-mode .sidebar .button {
      border: 1px solid #000;
      color: #000;
    }

    body.light-mode .sidebar .button:hover {
      background: #000;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    body.light-mode .profile {
      background: #000;
      color: #fff;
    }

    body.light-mode .profile-menu {
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.2);
    }

    body.light-mode .profile-menu button {
      color: #000;
    }

    body.light-mode .profile-menu button:hover {
      background: rgba(0,0,0,0.1);
    }

    body.light-mode .square div {
      background: #000;
    }

    body.light-mode .toggle-btn { background: #000; }
    body.light-mode .toggle-dot { background: #fff; }

    /* ---- Modern Input & Button Styles ---- */

    input[type="number"], 
    input[type="text"], 
    select {
      background: rgba(255,255,255,0.08);
      border: none;
      color: #fff;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      outline: none;
      transition: background 0.3s ease;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
    }

    input[type="number"]:focus, 
    input[type="text"]:focus {
      background: rgba(255,255,255,0.12);
    }

    /* Reusable clean input class */
    .input-dark {
      background: rgba(255,255,255,0.08);
      border: none;
      color: #fff;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      width: 260px;
      outline: none;
    }
    .input-dark:focus {
      background: rgba(255,255,255,0.12);
    }

    /* Modern Button */
    .button-modern {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 8px;
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .button-modern:hover {
      background: #fff;
      color: #000;
      box-shadow: 0 0 10px #fff;
    }
    .button-modern:disabled {
      opacity: 0.6;
      box-shadow: none;
    }
    /* Light Mode Adjustments */
    body.light-mode input[type="number"],
    body.light-mode input[type="text"],
    body.light-mode .input-dark {
      background: rgba(0,0,0,0.05);
      color: #000;
    }
    body.light-mode .button-modern {
      border: 1px solid #000;
      color: #000;
    }
    body.light-mode .button-modern:hover {
      background: #000;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
  <aside class="sidebar" id="sidebar">
    <img src="assets/bullride1055_v2.png" alt="Bullride Logo">

    <!-- MAIN NAVIGATION -->
    <button class="button" id="dashboardBtn">Dashboard</button>
    <button class="button" id="creationsBtn">My Creations</button>
    <button class="button" id="investmentsBtn">My Investments</button>
    <button class="button" id="exploreBtn">Explore</button>
    <button class="button" id="adminBtn" style="display:none;">Admin Panel</button>

    <p style="margin-top:1rem;font-size:0.9rem;opacity:0.8;">
      Welcome to your dashboard. Manage your ETFs, explore markets, and discover trending baskets.
    </p>
  </aside>

  <div class="toggle-btn" id="toggleSidebar">
    <div class="toggle-dot"></div>
  </div>

  <div class="profile" id="profileIcon">U</div>
  <div class="theme-toggle" id="themeToggle">
    <!-- Moon (default dark) -->
    <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z"/>
    </svg>

    <!-- Sun (light mode) -->
    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
      <path d="M12 18a6 6 0 100-12 6 6 0 000 12zm0 4a1 1 0 010-2h0a1 1 0 010 2zm0-20a1 1 0 010-2h0a1 1 0 010 2zm8.49 17.49a1 1 0 010-1.41h0a1 1 0 011.41 1.41h0a1 1 0 01-1.41 0zM3.51 4.51a1 1 0 010-1.41h0a1 1 0 011.41 1.41h0a1 1 0 01-1.41 0z"/>
    </svg>
  </div>

  <div class="profile-menu" id="profileMenu">
    <button>Settings</button>
    <button id="signOut">Sign Out</button>
  </div>

  <main>
    <h1>Dashboard</h1>
    <p class="lead">Explore and manage your investments — your personalized ETF hub.</p>

    <section class="grid">
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Your ETFs</h5>
      </div>
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Discover</h5>
      </div>
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Analytics</h5>
      </div>
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Performance</h5>
      </div>
    </section>
  </main>

    <script type="module">
    import { UserManager } from "https://cdn.jsdelivr.net/npm/oidc-client-ts@2.2.3/+esm";

    const userManager = new UserManager({
      authority: "https://cognito-idp.us-east-1.amazonaws.com/us-east-1_HPx82G5s7",
      client_id: "2l15ru0njbo72tv2skuceokjf2",
      redirect_uri: "https://bullride.us/dashboard",
      response_type: "code",
      scope: "openid email phone profile"
    });

    const API_BASE = "https://api.bullride.us";

    // ---------- Mini helpers for charts & math ----------
    const activeCharts = {};

    async function fetchBarsMulti(symbolsCsv, timeframe = "1Day", limit = 20) {
      let multiplier;
      switch (timeframe) {
        case "5Min": multiplier = 5 * 60 * 1000; break;
        case "1Hour": multiplier = 60 * 60 * 1000; break;
        case "1Day": default: multiplier = 24 * 60 * 60 * 1000; break;
      }
      const startParam = `&start=${new Date(Date.now() - multiplier * limit).toISOString()}`;
      const url = `${API_BASE}/api/stocks/bars?symbols=${encodeURIComponent(symbolsCsv)}&timeframe=${timeframe}&limit=${limit}${startParam}`;
      const r = await fetch(url);
      return await r.json();
    }

    async function drawMiniChart(symbol, canvas, timeframe = "1Day") {
      try {
        const data = await fetchBarsMulti(symbol, timeframe, 20);
        const arr = data?.bars?.[symbol] || [];
        if (arr.length === 0) return;

        const labels = arr.map(b => (b.t || '').slice(5, 10));
        const values = arr.map(b => b.c);
        const ctx = canvas.getContext("2d");

        // --- Determine line color ---
        const first = arr[0]?.c ?? 0;
        const last = arr[arr.length - 1]?.c ?? 0;

        function isAfterHours() {
          const now = new Date();
          const est = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" }));
          const hours = est.getHours() + est.getMinutes() / 60;
          return hours < 9.5 || hours >= 16; // before 9:30am or after 4pm ET
        }

        let borderColor;
        if (isAfterHours()) borderColor = "#5700ff"; // FFD700 yellow, 5700ff blue
        else if (last < first) borderColor = "#FF5555"; // red
        else borderColor = "#00FF7F"; // green

        // --- If chart already exists, update instead of destroy ---
        if (activeCharts[symbol]) {
          const chart = activeCharts[symbol];
          chart.data.labels = labels;
          chart.data.datasets[0].data = values;
          chart.data.datasets[0].borderColor = borderColor;
          chart.update(); // smooth update
          return;
        }

        // --- Otherwise, create new chart ---
        activeCharts[symbol] = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              data: values,
              borderColor,
              fill: false,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            animation: {
              duration: 600, // smooth transition
              easing: 'easeInOutCubic'
            },
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } },
            elements: { point: { radius: 0 } }
          }
        });
      } catch (err) {
        console.error(`Chart error for ${symbol}:`, err);
      }
    }

    function pctChange(oldVal, newVal) {
      if (!oldVal || oldVal === 0 || newVal == null) return 0;
      return ((newVal - oldVal) / oldVal) * 100;
    }

    // Make available to other scripts
    window.userManager = userManager;

    (async () => {
      try {
        // Handle Cognito redirect first
        if (window.location.search.includes("code=")) {
          await userManager.signinRedirectCallback();
          window.history.replaceState({}, document.title, "/dashboard");
          window.location.reload(); // refresh once after successful sign-in
        }

        // Check session
        const user = await userManager.getUser();
        if (!user || user.expired) {
          window.location.href = "https://bullride.us";
          return;
        }

        // Logged in — continue loading rest of the page
        initDashboard(user);
      } catch (err) {
        console.error("Login check failed:", err);
        window.location.href = "https://bullride.us";
      }
    })();

    // Everything else runs only after user verified
    async function initDashboard(user) {
      // existing dashboard code goes here ↓
      // (sidebar toggles, profile menu, theme toggle, etc.)
    }

    const sidebar = document.getElementById("sidebar");
    const toggleSidebar = document.getElementById("toggleSidebar");
    const profileIcon = document.getElementById("profileIcon");
    const profileMenu = document.getElementById("profileMenu");
    const themeToggle = document.getElementById("themeToggle");
    const moonIcon = document.getElementById("moonIcon");
    const sunIcon = document.getElementById("sunIcon");
    const logoImg = document.querySelector(".sidebar img");
    const body = document.body;

    // --- Sidebar toggle ---
    toggleSidebar.addEventListener("click", () => {
      if (window.innerWidth <= 768) sidebar.classList.toggle("active");
      else sidebar.classList.toggle("hidden");
    });

    // --- Profile menu toggle ---
    profileIcon.addEventListener("click", (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle("active");
    });

    // --- Close profile menu when clicking outside ---
    document.addEventListener("click", (e) => {
      if (!profileMenu.contains(e.target) && !profileIcon.contains(e.target)) {
        profileMenu.classList.remove("active");
      }
    });

    // --- Load Cognito user and set initials ---
    async function loadUser() {
      try {
        let user = await userManager.getUser();
        if (!user) user = await userManager.signinRedirectCallback();
        if (user && user.profile) {
          const fullName = user.profile.name || user.profile.given_name || user.profile.email || "User";
          const names = fullName.split(" ");
          const initials = (names[0]?.[0] || "") + (names[1]?.[0] || "");
          document.getElementById("profileIcon").textContent = initials.toUpperCase();
        }
      } catch (err) {
        console.error("Error loading user:", err);
      }
    }

    loadUser();

    // --- Show Admin Panel only for @bullride.us users ---
    async function checkAdminAccess() {
      try {
        const user = await userManager.getUser();
        if (user && user.profile && user.profile.email && user.profile.email.endsWith("@bullride.us")) {
          document.getElementById("adminBtn").style.display = "block";
        }
      } catch (err) {
        console.error("Error checking admin access:", err);
      }
    }

    checkAdminAccess();

    // --- THEME TOGGLE (Dark / Light Mode) ---
    const savedTheme = localStorage.getItem("bullride-theme");
    if (savedTheme === "light") {
      body.classList.add("light-mode");
      moonIcon.style.display = "none";
      sunIcon.style.display = "block";
      logoImg.src = "assets/bullride1055_v2_light.png";
    } else {
      logoImg.src = "assets/bullride1055_v2.png";
    }

    themeToggle.addEventListener("click", () => {
      const light = body.classList.toggle("light-mode");
      if (light) {
        moonIcon.style.display = "none";
        sunIcon.style.display = "block";
        logoImg.src = "assets/bullride1055_v2_light.png";
        localStorage.setItem("bullride-theme", "light");
      } else {
        sunIcon.style.display = "none";
        moonIcon.style.display = "block";
        logoImg.src = "assets/bullride1055_v2.png";
        localStorage.setItem("bullride-theme", "dark");
      }
    });

    // --- SETTINGS PAGE ---
    document.querySelector("#profileMenu button:nth-child(1)").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>Settings</h1>
        <p class="lead">View your account information and preferences.</p>

        <section style="max-width:500px;">
          <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <h3 style="margin-bottom:1rem;">Profile Information</h3>
            <p><strong>Username:</strong> <span id="displayUsername">Loading...</span></p>
            <p><strong>Name:</strong> <span id="displayName">Loading...</span></p>
            <p><strong>Phone Number:</strong> <span id="displayPhone">Loading...</span></p>
            <p><strong>Email:</strong> <span id="displayEmail">Loading...</span>
              <span id="emailVerified" style="font-size:0.9rem;margin-left:8px;color:#aaa;">(checking...)</span></p>
          </div>
        </section>
      `;

      try {
        const user = await userManager.getUser();

        document.getElementById("displayUsername").textContent = user?.profile?.preferred_username || user?.profile?.username || "(Not available)";
        document.getElementById("displayName").textContent = user?.profile?.name || "(Not provided)";
        document.getElementById("displayPhone").textContent = user?.profile?.phone_number || "(Not provided)";
        document.getElementById("displayEmail").textContent = user?.profile?.email || "(Not provided)";

        if (user?.profile?.email_verified === true || user?.profile?.email_verified === "true") {
          document.getElementById("emailVerified").textContent = "(verified)";
          document.getElementById("emailVerified").style.color = "lightgreen";
        } else {
          document.getElementById("emailVerified").textContent = "(unverified)";
          document.getElementById("emailVerified").style.color = "orange";
        }
      } catch (err) {
        console.error("Error loading user info:", err);
        document.querySelector("section").innerHTML = "<p style='color:red;'>Failed to load user data.</p>";
      }
    });

    // --- DASHBOARD BUTTON (reload main view) ---
    document.getElementById("dashboardBtn").addEventListener("click", () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>Dashboard</h1>
        <p class="lead">Explore and manage your investments — your personalized ETF hub.</p>
        <section class="grid">
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Your ETFs</h5>
          </div>
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Discover</h5>
          </div>
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Analytics</h5>
          </div>
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Performance</h5>
          </div>
        </section>
      `;
    });

    // --- SIGN OUT ---
    document.getElementById("signOut").addEventListener("click", async () => {
      try {
        const user = await userManager.getUser();
        const clientId = "2l15ru0njbo72tv2skuceokjf2";
        const logoutUri = "https://bullride.us";
        const logoutUrl = `https://auth.bullride.us/logout?client_id=${clientId}&logout_uri=${encodeURIComponent(logoutUri)}`;
        if (user) await userManager.removeUser();
        window.location.href = logoutUrl;
      } catch {
        window.location.href = "https://bullride.us";
      }
    });

    // --- MY CREATIONS PAGE ---
    document.getElementById("creationsBtn").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>My Creations</h1>
        <p class="lead">Your custom ETF baskets.</p>

        <section id="basketsGrid"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.6rem;margin-top:1rem;">
          <p>Loading baskets...</p>
        </section>
      `;

      const grid = document.getElementById("basketsGrid");

      try {
        const user = await userManager.getUser();
        const email = user?.profile?.email;
        const res = await fetch(`${API_BASE}/api/baskets/user?email=${encodeURIComponent(email)}`);
        const baskets = await res.json();

        grid.innerHTML = "";

        // Show user's baskets if any
        if (Array.isArray(baskets) && baskets.length > 0) {
          baskets.forEach(b => {
            const card = document.createElement("div");
            card.style.cssText = `
              background:rgba(255,255,255,0.06);
              padding:1.4rem 1.6rem;
              border-radius:14px;
              border:1px solid rgba(255,255,255,0.15);
              text-align:center;
              transition:transform .2s ease, box-shadow .2s ease;
              cursor:pointer;
            `;

            // Hover animation
            card.addEventListener("mouseenter", () => {
              card.style.boxShadow = "0 0 12px rgba(255,255,255,0.25)";
              card.style.transform = "translateY(-3px)";
            });
            card.addEventListener("mouseleave", () => {
              card.style.boxShadow = "none";
              card.style.transform = "none";
            });

            const inactive = b.active === false ? " (inactive)" : "";

            card.innerHTML = `
              <h3 style="margin:0 0 .5rem 0;font-size:1.25rem;font-weight:600;">
                ${b.name}${inactive}
              </h3>
              <p style="margin:0 0 .5rem 0;opacity:.9;">
                ${b.stocks.length} stock${b.stocks.length !== 1 ? "s" : ""}
              </p>
              <button class="delete-basket button-modern"
                style="margin-top:0.8rem;width:100%;">
                Delete Basket
              </button>
            `;

            // Delete basket → soft delete (sets active=false)
            const delBtn = card.querySelector(".delete-basket");
            delBtn.addEventListener("click", async (e) => {
              e.stopPropagation();
              if (!confirm("Delete this basket? It will become inactive.")) return;
              try {
                const res = await fetch(`${API_BASE}/api/baskets/${b.basketId}`, { method: "DELETE" });
                if (!res.ok) throw new Error("Failed to delete");
                alert("Basket marked inactive.");
                document.getElementById("creationsBtn").click(); // reload list
              } catch (err) {
                console.error("Delete basket error:", err);
                alert("Failed to delete basket.");
              }
            });

            grid.appendChild(card);
          });
        } else {
          grid.innerHTML = "<p style='opacity:0.8;'>You haven't created any baskets yet.</p>";
        }

        // --- Create New Basket button ---
        const create = document.createElement("div");
        create.style.cssText = `
          display:flex;
          align-items:center;
          justify-content:center;
          border:2px dashed rgba(255,255,255,0.3);
          border-radius:14px;
          cursor:pointer;
          transition:all 0.3s ease;
          height:150px;
          background:rgba(255,255,255,0.03);
        `;
        create.innerHTML = `<span style="font-size:1.2rem;opacity:0.8;">+ Create New Basket</span>`;

        create.addEventListener("mouseenter", () => {
          create.style.background = "rgba(255,255,255,0.06)";
          create.style.boxShadow = "0 0 10px rgba(255,255,255,0.15)";
        });
        create.addEventListener("mouseleave", () => {
          create.style.background = "rgba(255,255,255,0.03)";
          create.style.boxShadow = "none";
        });

        // Open visual basket builder
        create.addEventListener("click", async () => {
          const userNow = await userManager.getUser();
          openBasketBuilder(userNow); // your builder function
        });

        grid.appendChild(create);
      } catch (err) {
        console.error("Error loading baskets:", err);
        grid.innerHTML = "<p style='color:red;'>Failed to load baskets.</p>";
      }
    });



    // --- MY INVESTMENTS PAGE ---
    document.getElementById("investmentsBtn").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>My Investments</h1>
        <p class="lead">Baskets you've purchased or invested in — your active portfolio overview.</p>

        <section id="investmentsGrid"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.6rem;margin-top:1rem;">
        </section>
      `;

      const grid = document.getElementById("investmentsGrid");

      // (Static sample data for now — later will be replaced with user portfolio fetch)
      const sample = [
        { name: "AI Innovators Fund", creator: "@sophia", gain: +8.7 },
        { name: "Green Energy Growth", creator: "You", gain: +2.1 },
        { name: "Tech Titans Basket", creator: "You", gain: -1.4 },
      ];

      sample.forEach(item => {
        const card = document.createElement("div");
        card.style.cssText = `
          background:rgba(255,255,255,0.06);
          padding:1.4rem 1.6rem;
          border-radius:14px;
          border:1px solid rgba(255,255,255,0.15);
          transition:transform .2s ease, box-shadow .2s ease;
          cursor:pointer;
        `;

        // Hover glow
        card.addEventListener("mouseenter", () => {
          card.style.boxShadow = "0 0 12px rgba(255,255,255,0.25)";
          card.style.transform = "translateY(-3px)";
        });
        card.addEventListener("mouseleave", () => {
          card.style.boxShadow = "none";
          card.style.transform = "none";
        });

        const gainColor = item.gain >= 0 ? "lightgreen" : "salmon";
        const sign = item.gain >= 0 ? "+" : "";

        card.innerHTML = `
          <h3 style="margin:0 0 .5rem 0;font-size:1.25rem;font-weight:600;">${item.name}</h3>
          <p style="opacity:.85;margin:0 0 .6rem 0;font-size:0.95rem;">Created by ${item.creator}</p>
          <p style="margin:0 0 .8rem 0;font-size:1rem;">
            Return: <strong style="color:${gainColor}">${sign}${item.gain.toFixed(1)}%</strong>
          </p>
          <button class="button-modern" style="width:100%;">View Details</button>
        `;

        grid.appendChild(card);
      });
    });

    // Basket open
    async function openBasketBuilder(user) {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>Create Basket</h1>
        <p class="lead">Search & select stocks, adjust timeframes, set shares, and finalize.</p>

        <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:10px 0 20px;">
          <input id="basketName" class="input-dark" placeholder="Basket Name">
          <input id="stockSearch" class="input-dark" placeholder="Search by ticker or name (e.g., AAPL, Microsoft)" style="width:320px;">
          <button id="searchBtn" class="button-modern">Search</button>
          <label style="opacity:0.8;margin-left:8px;">Timeframe:</label>
          <select id="tfSelect" class="input-dark" style="width:120px;">
            <option value="1Day" selected>1 Day</option>
            <option value="5Min">5 Min</option>
            <option value="1Hour">1 Hour</option>
          </select>
          <button id="showPopularBtn" class="button-modern">Show Popular</button>
        </div>

        <section id="stocksGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.2rem;">
          <p>Loading popular stocks...</p>
        </section>

        <section id="previewSection" style="margin-top:2rem;">
          <h3>Basket Preview</h3>
          <div id="previewList" style="margin-top:0.8rem;opacity:0.9;">No stocks selected yet.</div>
          <button id="finalizeBtn" class="button-modern" style="margin-top:1.2rem;display:none;">Finalize Basket</button>
        </section>
      `;

      const stocksGrid = document.getElementById("stocksGrid");
      const tfSelect = document.getElementById("tfSelect");
      const searchBtn = document.getElementById("searchBtn");
      const showPopularBtn = document.getElementById("showPopularBtn");
      const previewList = document.getElementById("previewList");
      const finalizeBtn = document.getElementById("finalizeBtn");
      const userEmail = user?.profile?.email;

      // selected: { AAPL: { symbol:'AAPL', shares:1, price:<latestBid> } }
      let selected = {};
      let currentTimeframe = tfSelect.value;

    async function loadPopular() {
      // Clean up old charts before replacing DOM
      Object.values(activeCharts).forEach(ch => ch.destroy());
      for (const key in activeCharts) delete activeCharts[key];

      stocksGrid.innerHTML = `<p>Loading popular stocks...</p>`;

      const res = await fetch(`${API_BASE}/api/stocks/popular`);
      const list = await res.json(); // [{symbol, quote}]
      renderStocks(list);

      tfSelect.dispatchEvent(new Event("change"));
    }

    async function search() {
      const q = document.getElementById("stockSearch").value.trim();
      if (!q || q.length < 1) {
        stocksGrid.innerHTML = `<p>Please enter a valid ticker symbol.</p>`;
        return;
      }

      // Clean up any previous charts before rendering new results
      Object.values(activeCharts).forEach(ch => ch.destroy());
      for (const key in activeCharts) delete activeCharts[key];

      stocksGrid.innerHTML = `<p>Searching...</p>`;

      try {
        // Pull a full list of popular stocks to fuzzy match client-side
        const res = await fetch(`${API_BASE}/api/stocks/popular`);
        if (!res.ok) {
          console.error("Search failed: HTTP", res.status);
          stocksGrid.innerHTML = `<p style="color:red;">Search failed (HTTP ${res.status}).</p>`;
          return;
        }

        let list = await res.json();

        // --- Fuzzy match symbols or names (case-insensitive)
        const query = q.toLowerCase();
        list = list.filter(item =>
          item.symbol.toLowerCase().includes(query) ||
          (item.name && item.name.toLowerCase().includes(query))
        );

        if (!Array.isArray(list) || list.length === 0) {
          stocksGrid.innerHTML = `<p style="opacity:0.8;">No results found for "${q}".</p>`;
          return;
        }

        // Render fuzzy-matched results
        renderStocks(list);
      } catch (err) {
        console.error("Search error:", err);
        stocksGrid.innerHTML = `<p style="color:red;">Search failed. Please try again later.</p>`;
      }
    }

      function renderStocks(list) {
        stocksGrid.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
          stocksGrid.innerHTML = `<p style="opacity:0.8;">No results.</p>`;
          return;
        }

      function createCard(item) {
        const sym = item.symbol;
        const bid = item?.quote?.bp ?? null;
        const ask = item?.quote?.ap ?? null;
        const mid = (bid && ask) ? ((bid + ask) / 2) : (bid ?? ask ?? null);

        const card = document.createElement("div");
        card.className = "stock-card";
        card.style.cssText = `
          background:rgba(255,255,255,0.05);
          border:2px solid transparent;
          border-radius:12px;
          padding:1rem;
          cursor:pointer;
          transition:all .2s ease;
        `;

        card.innerHTML = `
          <div style="display:flex;align-items:baseline;justify-content:space-between;gap:8px;">
            <h3 style="margin:0;">${sym}</h3>
            <span style="opacity:.8;">${mid ? `$${mid.toFixed(2)}` : '—'}</span>
          </div>
          <canvas id="mini-${sym}" height="120"></canvas>
          <div class="shares-row" style="display:none;margin-top:8px;">
            <label style="opacity:.8;font-size:.9rem;">Shares:</label>
            <input type="number" min="0.01" step="0.01" value="${selected[sym]?.shares ?? 1}" id="shares-${sym}"
              style="width:100px;padding:.5rem;border-radius:8px;border:none;
                    background:rgba(255,255,255,0.08);color:#fff;margin-left:8px;">
          </div>
        `;

        card.addEventListener("click", e => {
          if (e.target && e.target.id.startsWith("shares-")) return;
          if (selected[sym]) {
            delete selected[sym];
            card.style.borderColor = "transparent";
            card.querySelector(".shares-row").style.display = "none";
          } else {
            selected[sym] = {
              symbol: sym,
              name: item.name || sym,
              shares: 1,
              price: mid || 0
            };
            card.style.borderColor = "#00FF7F";
            card.querySelector(".shares-row").style.display = "block";
          }
          updatePreview();
        });

        card.addEventListener("input", e => {
          if (e.target.id === `shares-${sym}`) {
            const v = parseFloat(e.target.value || "1");
            if (selected[sym]) selected[sym].shares = Math.max(0.01, v);
            updatePreview();
          }
        });

        stocksGrid.appendChild(card);
        drawMiniChart(sym, card.querySelector(`#mini-${sym}`), currentTimeframe);
      }

      // Paginate all cards (16 per page)
      renderPaginatedCards(stocksGrid, list, createCard);

        tfSelect.dispatchEvent(new Event("change"));
      }

      function cleanCompanyName(name) {
        if (!name) return "";
        
        let cleaned = name
          // Remove unwanted terms (company types, share classes, etc.)
          .replace(/\b(Common|Preferred|Ordinary|Depositary|Class [A-Z])\b/gi, "")
          .replace(/\b(Stock|Shares?|Inc\.?|Corp\.?|Corporation|PLC|LLC|Ltd\.?)\b/gi, "")
          // Clean up punctuation and extra spaces
          .replace(/[.,]+(?=\s|$)/g, "")        // remove dangling punctuation
          .replace(/\s{2,}/g, " ")              // collapse multiple spaces
          .trim();

        // Preserve ETF, Fund, or Trust identifiers
        if (/\b(ETF|Fund|Trust)\b/i.test(name)) {
          const match = name.match(/\b(ETF|Fund|Trust)\b/i);
          if (match && !cleaned.includes(match[0])) cleaned += ` ${match[0]}`;
        }

        // Remove leftover punctuation again after appending ETF/Fund
        cleaned = cleaned.replace(/[.,]+(?=\s|$)/g, "").trim();

        return cleaned;
      }

      function updatePreview() {
        const entries = Object.values(selected);
        if (entries.length === 0) {
          previewList.innerHTML = "No stocks selected yet.";
          finalizeBtn.style.display = "none";
          return;
        }

        let total = 0;
        const rows = entries.map(s => {
          const est = s.price * s.shares;
          total += est;
          return `
            <div>${s.symbol}</div>
            <div>${cleanCompanyName(s.name)}</div>
            <div>${s.shares.toFixed(2)}</div>
            <div>$${est.toFixed(2)}</div>
          `;
        }).join("");

        previewList.innerHTML = `
          <div style="
            display:grid;
            grid-template-columns:1fr 1.5fr 1fr 1fr;
            gap:.6rem;
            font-size:0.95rem;
            color:#fff;
          ">
            <strong>Symbol</strong>
            <strong>Company</strong>
            <strong>Shares</strong>
            <strong>Est. Value</strong>
            ${rows}
            <div></div><div></div><strong>Total</strong><strong>$${total.toFixed(2)}</strong>
          </div>
        `;

        finalizeBtn.style.display = "inline-block";
      }

      // actions
      tfSelect.addEventListener("change", () => {
        currentTimeframe = tfSelect.value;
        // redraw all visible cards
        document.querySelectorAll("canvas[id^='mini-']").forEach(cv => {
          const sym = cv.id.replace("mini-",""); 
          drawMiniChart(sym, cv, currentTimeframe);
        });
      });

      let buttonCooldown = false;

      async function triggerWithCooldown(actionFn, label) {
        if (buttonCooldown) return;
        buttonCooldown = true;

        // disable both buttons and show loading state
        searchBtn.disabled = true;
        showPopularBtn.disabled = true;
        const originalSearchText = searchBtn.textContent;
        const originalPopularText = showPopularBtn.textContent;

        if (label === "search") searchBtn.textContent = "Searching...";
        else showPopularBtn.textContent = "Loading...";

        try {
          await actionFn();
        } catch (err) {
          console.error("Button action error:", err);
        } finally {
          // restore both buttons
          setTimeout(() => {
            buttonCooldown = false;
            searchBtn.disabled = false;
            showPopularBtn.disabled = false;
            searchBtn.textContent = originalSearchText;
            showPopularBtn.textContent = originalPopularText;
          }, 2000); // cooldown delay in ms
        }
      }

      searchBtn.addEventListener("click", () => triggerWithCooldown(search, "search"));
      showPopularBtn.addEventListener("click", () => triggerWithCooldown(loadPopular, "popular"));

      finalizeBtn.addEventListener("click", async () => {
        const name = (document.getElementById("basketName").value || "").trim() || "Untitled Basket";
        const stocks = Object.values(selected);
        if (stocks.length === 0) return alert("Select at least one stock.");
        try {
          const res = await fetch(`${API_BASE}/api/baskets/create`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userEmail, name, stocks })
          });
          if (!res.ok) throw new Error("Create failed");
          alert("Basket created!");
          document.getElementById("creationsBtn").click(); // go back to list
        } catch (e) {
          console.error(e);
          alert("Failed to create basket.");
        }
      });

      // init
      loadPopular();
    }

    // --- EXPLORE PAGE (public baskets, sorted by biggest gainers) ---
    document.getElementById("exploreBtn").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>Explore</h1>
        <p class="lead">Public baskets across all users, sorted by biggest gainers.</p>
        <section id="exploreGrid"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.6rem;margin-top:1rem;">
          <p>Loading baskets...</p>
        </section>
      `;

      const grid = document.getElementById("exploreGrid");

      try {
        const res = await fetch(`${API_BASE}/api/baskets/explore`);
        let baskets = await res.json();

        // Collect all unique symbols (cap at 120)
        const allSyms = Array.from(
          new Set(baskets.flatMap(b => (b.stocks || []).map(s => s.symbol)))
        ).slice(0, 120);

        // Fetch latest bars for those symbols
        const barData = await fetchBarsMulti(allSyms.join(','), "1Day", 2);
        const lastChangeBySymbol = {};

        for (const s of allSyms) {
          const arr = barData?.bars?.[s] || [];
          if (arr.length >= 2) {
            const yClose = arr[arr.length - 2].c;
            const tClose = arr[arr.length - 1].c;
            lastChangeBySymbol[s] = pctChange(yClose, tClose);
          } else lastChangeBySymbol[s] = 0;
        }

        // Compute basket % change (weighted by shares)
        baskets.forEach(b => {
          const comps = b.stocks || [];
          const totalShares = comps.reduce((a, c) => a + (Number(c.shares) || 0), 0) || 1;
          const score = comps.reduce(
            (acc, c) => acc + (lastChangeBySymbol[c.symbol] || 0) * (Number(c.shares) || 0),
            0
          ) / totalShares;
          b._gainPct = score;
        });

        // Sort by biggest gainers
        baskets.sort((a, b) => (b._gainPct || 0) - (a._gainPct || 0));

        // Render cards
        grid.innerHTML = "";
        baskets.forEach(b => {
          const card = document.createElement("div");
          card.style.cssText = `
            background:rgba(255,255,255,0.06);
            padding:1.4rem 1.6rem;
            border-radius:14px;
            border:1px solid rgba(255,255,255,0.15);
            transition:transform .2s ease, box-shadow .2s ease;
            cursor:pointer;
          `;

          // Hover glow
          card.addEventListener("mouseenter", () => {
            card.style.boxShadow = "0 0 12px rgba(255,255,255,0.25)";
            card.style.transform = "translateY(-3px)";
          });
          card.addEventListener("mouseleave", () => {
            card.style.boxShadow = "none";
            card.style.transform = "none";
          });

          const tag = b.active === false ? " (inactive)" : "";
          const gainColor = (b._gainPct || 0) >= 0 ? "lightgreen" : "salmon";

          card.innerHTML = `
            <h3 style="margin:0 0 .5rem 0;font-size:1.25rem;font-weight:600;">
              ${b.name}${tag}
            </h3>
            <p style="opacity:.85;margin:0 0 .6rem 0;font-size:0.95rem;">
              <strong>By:</strong> ${b.userEmail}
            </p>
            <p style="margin:0 0 .6rem 0;opacity:.9;">
              <strong>${b.stocks.length}</strong> stock${b.stocks.length !== 1 ? "s" : ""}
            </p>
            <p style="margin:0;font-size:1rem;">
              Est. 1D Change:
              <strong style="color:${gainColor}">${(b._gainPct || 0).toFixed(2)}%</strong>
            </p>
          `;

          grid.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        grid.innerHTML = "<p style='color:red;'>Failed to load explore baskets.</p>";
      }
    });

    // --- ADMIN PANEL BUTTON (redirect to admin page) ---
    document.getElementById("adminBtn").addEventListener("click", () => {
      window.location.href = "https://bullride.us/bradminlc_1.html";
    });

        // ----- PAGINATION HANDLER -----
        function renderPaginatedCards(container, items, renderFn, perPage = 16) {
          let currentPage = 1;
          const totalPages = Math.ceil(items.length / perPage);

          const paginationDiv = document.createElement("div");
          paginationDiv.style.cssText = `
            text-align:center;
            margin-top:1.5rem;
            display:flex;
            justify-content:center;
            align-items:center;
            gap:1rem;
          `;

          const prevBtn = document.createElement("button");
          const nextBtn = document.createElement("button");
          const pageText = document.createElement("span");

          prevBtn.textContent = "← Previous";
          nextBtn.textContent = "Next →";
          pageText.style.opacity = "0.7";

          [prevBtn, nextBtn].forEach(btn => {
            btn.className = "button-modern";
            btn.style.padding = "0.5rem 1rem";
          });

          function updatePage() {
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageItems = items.slice(start, end);

            container.style.opacity = "0";
            setTimeout(() => {
              container.innerHTML = "";
              pageItems.forEach(renderFn);
              container.style.opacity = "1";
            }, 200);

            pageText.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
          }

          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              currentPage--;
              updatePage();
            }
          });

          nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
              currentPage++;
              updatePage();
            }
          });

          paginationDiv.appendChild(prevBtn);
          paginationDiv.appendChild(pageText);
          paginationDiv.appendChild(nextBtn);

          container.insertAdjacentElement("afterend", paginationDiv);
          updatePage();
        }

  </script>
</body>
</html>