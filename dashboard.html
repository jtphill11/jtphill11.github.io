<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bullride | Dashboard</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      color: #fff;
      overflow-x: hidden;
      line-height: 1.6;
      transition: background 0.4s ease, color 0.4s ease;
    }

    a { color: white; text-decoration: none; transition: 0.3s ease; }
    a:hover { color: #999; }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 260px;
      height: 100vh;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      transform: translateX(0);
      transition: transform 0.4s ease, background 0.4s ease, border 0.4s ease;
      z-index: 200;
    }

    .sidebar.hidden { transform: translateX(-100%); }

    .sidebar img {
      width: 140px;
      margin-bottom: 2rem;
      filter: brightness(1.5);
      transition: filter 0.4s ease;
    }

    .sidebar .button {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      text-align: center;
    }

    .sidebar .button:hover {
      background: #fff;
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 0 10px #fff;
    }

    /* Toggle Button */
    .toggle-btn {
      position: fixed;
      top: 25px;
      left: 20px;
      background: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 300;
      transition: transform 0.3s ease, background 0.3s ease;
    }

    .toggle-btn:hover { transform: scale(1.1); }

    .toggle-dot {
      width: 10px;
      height: 10px;
      background: #000;
      border-radius: 50%;
      transition: transform 0.3s ease, background 0.3s ease;
    }

    /* Profile icon */
    .profile {
      position: fixed;
      top: 20px;
      right: 70px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #fff;
      color: #000;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      z-index: 300;
      transition: transform 0.3s ease, background 0.4s ease, color 0.4s ease;
    }

    .profile:hover { transform: scale(1.05); }

    /* Theme icon toggle (sun/moon) */
    .theme-toggle {
      position: fixed;
      top: 22px;
      right: 25px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: none;
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
      z-index: 310;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.1);
    }

    .theme-toggle svg {
      width: 22px;
      height: 22px;
      fill: #fff;
      transition: fill 0.4s ease;
    }

    body.light-mode .theme-toggle svg {
      fill: #000;
    }

    /* Profile dropdown */
    .profile-menu {
      position: absolute;
      top: 70px;
      right: 30px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      backdrop-filter: blur(12px);
      overflow: hidden;
      display: none;
      flex-direction: column;
      width: 180px;
      animation: fadeIn 0.3s ease forwards;
      z-index: 400;
      transition: background 0.4s ease, border 0.4s ease;
    }

    .profile-menu.active { display: flex; }

    .profile-menu button {
      background: none;
      border: none;
      color: #fff;
      padding: 0.9rem;
      text-align: left;
      width: 100%;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .profile-menu button:hover { background: rgba(255,255,255,0.15); }

    /* Main content */
    main {
      margin-left: 280px;
      padding: 4rem 3rem;
      transition: margin-left 0.4s ease, background 0.4s ease, color 0.4s ease;
    }

    .sidebar.hidden ~ main { margin-left: 0; }

    h1 {
      font-size: 2.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .lead {
      font-size: 1.2rem;
      color: #aaa;
      max-width: 700px;
      margin-bottom: 3rem;
    }

    /* Grid Squares */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 2rem;
      margin-bottom: 4rem;
    }

    .cell {
      text-align: center;
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0.9;
    }

    .cell:hover {
      transform: translateY(-5px);
      opacity: 1;
    }

    .square {
      width: 75px;
      height: 75px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 3px;
      background: none;
      margin: 0 auto 1rem;
      animation: rotateSquare 10s linear infinite;
      transform-origin: center;
      cursor: pointer;
      transition: transform 0.4s ease, box-shadow 0.4s ease, gap 0.4s ease;
    }

    .square div {
      background: #fff;
      border-radius: 2px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .square:hover {
      transform: scale(1.25);
      gap: 6px;
      box-shadow: 0 0 25px rgba(255,255,255,0.6);
    }

    @keyframes rotateSquare {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* MOBILE */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 260px; }
      .sidebar.active { transform: translateX(0); }
      main { margin-left: 0; padding: 2rem; }
      .toggle-btn { top: 15px; left: 15px; }
    }

    /* LIGHT MODE */
    body.light-mode {
      background-color: #fff;
      color: #000;
    }

    body.light-mode .sidebar {
      background: rgba(0,0,0,0.05);
      border-right: 1px solid rgba(0,0,0,0.1);
    }

    body.light-mode .sidebar .button {
      border: 1px solid #000;
      color: #000;
    }

    body.light-mode .sidebar .button:hover {
      background: #000;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    body.light-mode .profile {
      background: #000;
      color: #fff;
    }

    body.light-mode .profile-menu {
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.2);
    }

    body.light-mode .profile-menu button {
      color: #000;
    }

    body.light-mode .profile-menu button:hover {
      background: rgba(0,0,0,0.1);
    }

    body.light-mode .square div {
      background: #000;
    }

    body.light-mode .toggle-btn { background: #000; }
    body.light-mode .toggle-dot { background: #fff; }
  </style>

</head>

<body>
  <aside class="sidebar" id="sidebar">
    <img src="assets/bullride1055_v2.png" alt="Bullride Logo">

    <!-- MAIN NAVIGATION -->
    <button class="button" id="dashboardBtn">Dashboard</button>
    <button class="button" id="creationsBtn">My Creations</button>
    <button class="button" id="investmentsBtn">My Investments</button>
    <button class="button" id="exploreBtn">Explore</button>
    <button class="button" id="adminBtn" style="display:none;">Admin Panel</button>

    <p style="margin-top:1rem;font-size:0.9rem;opacity:0.8;">
      Welcome to your dashboard. Manage your ETFs, explore markets, and discover trending baskets.
    </p>
  </aside>

  <div class="toggle-btn" id="toggleSidebar">
    <div class="toggle-dot"></div>
  </div>

  <div class="profile" id="profileIcon">U</div>
  <div class="theme-toggle" id="themeToggle">
    <!-- Moon (default dark) -->
    <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z"/>
    </svg>

    <!-- Sun (light mode) -->
    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
      <path d="M12 18a6 6 0 100-12 6 6 0 000 12zm0 4a1 1 0 010-2h0a1 1 0 010 2zm0-20a1 1 0 010-2h0a1 1 0 010 2zm8.49 17.49a1 1 0 010-1.41h0a1 1 0 011.41 1.41h0a1 1 0 01-1.41 0zM3.51 4.51a1 1 0 010-1.41h0a1 1 0 011.41 1.41h0a1 1 0 01-1.41 0z"/>
    </svg>
  </div>

  <div class="profile-menu" id="profileMenu">
    <button>Settings</button>
    <button id="signOut">Sign Out</button>
  </div>

  <main>
    <h1>Dashboard</h1>
    <p class="lead">Explore and manage your investments — your personalized ETF hub.</p>

    <section class="grid">
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Your ETFs</h5>
      </div>
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Discover</h5>
      </div>
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Analytics</h5>
      </div>
      <div class="cell">
        <div class="square">
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
          <div></div><div></div><div></div>
        </div>
        <h5>Performance</h5>
      </div>
    </section>
  </main>

    <script type="module">
    import { UserManager } from "https://cdn.jsdelivr.net/npm/oidc-client-ts@2.2.3/+esm";

    const userManager = new UserManager({
      authority: "https://cognito-idp.us-east-1.amazonaws.com/us-east-1_HPx82G5s7",
      client_id: "2l15ru0njbo72tv2skuceokjf2",
      redirect_uri: "https://bullride.us/dashboard",
      response_type: "code",
      scope: "openid email phone profile"
    });

    const API_BASE = "https://api.bullride.us";

    // Make available to other scripts
    window.userManager = userManager;

    (async () => {
      try {
        // Handle Cognito redirect first
        if (window.location.search.includes("code=")) {
          await userManager.signinRedirectCallback();
          window.history.replaceState({}, document.title, "/dashboard");
          window.location.reload(); // refresh once after successful sign-in
        }

        // Check session
        const user = await userManager.getUser();
        if (!user || user.expired) {
          window.location.href = "https://bullride.us";
          return;
        }

        // Logged in — continue loading rest of the page
        initDashboard(user);
      } catch (err) {
        console.error("Login check failed:", err);
        window.location.href = "https://bullride.us";
      }
    })();

    // Everything else runs only after user verified
    async function initDashboard(user) {
      // existing dashboard code goes here ↓
      // (sidebar toggles, profile menu, theme toggle, etc.)
    }

    const sidebar = document.getElementById("sidebar");
    const toggleSidebar = document.getElementById("toggleSidebar");
    const profileIcon = document.getElementById("profileIcon");
    const profileMenu = document.getElementById("profileMenu");
    const themeToggle = document.getElementById("themeToggle");
    const moonIcon = document.getElementById("moonIcon");
    const sunIcon = document.getElementById("sunIcon");
    const logoImg = document.querySelector(".sidebar img");
    const body = document.body;

    // --- Sidebar toggle ---
    toggleSidebar.addEventListener("click", () => {
      if (window.innerWidth <= 768) sidebar.classList.toggle("active");
      else sidebar.classList.toggle("hidden");
    });

    // --- Profile menu toggle ---
    profileIcon.addEventListener("click", (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle("active");
    });

    // --- Close profile menu when clicking outside ---
    document.addEventListener("click", (e) => {
      if (!profileMenu.contains(e.target) && !profileIcon.contains(e.target)) {
        profileMenu.classList.remove("active");
      }
    });

    // --- Load Cognito user and set initials ---
    async function loadUser() {
      try {
        let user = await userManager.getUser();
        if (!user) user = await userManager.signinRedirectCallback();
        if (user && user.profile) {
          const fullName = user.profile.name || user.profile.given_name || user.profile.email || "User";
          const names = fullName.split(" ");
          const initials = (names[0]?.[0] || "") + (names[1]?.[0] || "");
          document.getElementById("profileIcon").textContent = initials.toUpperCase();
        }
      } catch (err) {
        console.error("Error loading user:", err);
      }
    }

    loadUser();

    // --- Show Admin Panel only for @bullride.us users ---
    async function checkAdminAccess() {
      try {
        const user = await userManager.getUser();
        if (user && user.profile && user.profile.email && user.profile.email.endsWith("@bullride.us")) {
          document.getElementById("adminBtn").style.display = "block";
        }
      } catch (err) {
        console.error("Error checking admin access:", err);
      }
    }

    checkAdminAccess();

    // --- THEME TOGGLE (Dark / Light Mode) ---
    const savedTheme = localStorage.getItem("bullride-theme");
    if (savedTheme === "light") {
      body.classList.add("light-mode");
      moonIcon.style.display = "none";
      sunIcon.style.display = "block";
      logoImg.src = "assets/bullride1055_v2_light.png";
    } else {
      logoImg.src = "assets/bullride1055_v2.png";
    }

    themeToggle.addEventListener("click", () => {
      const light = body.classList.toggle("light-mode");
      if (light) {
        moonIcon.style.display = "none";
        sunIcon.style.display = "block";
        logoImg.src = "assets/bullride1055_v2_light.png";
        localStorage.setItem("bullride-theme", "light");
      } else {
        sunIcon.style.display = "none";
        moonIcon.style.display = "block";
        logoImg.src = "assets/bullride1055_v2.png";
        localStorage.setItem("bullride-theme", "dark");
      }
    });

    // --- SETTINGS PAGE ---
    document.querySelector("#profileMenu button:nth-child(1)").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>Settings</h1>
        <p class="lead">View your account information and preferences.</p>

        <section style="max-width:500px;">
          <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <h3 style="margin-bottom:1rem;">Profile Information</h3>
            <p><strong>Username:</strong> <span id="displayUsername">Loading...</span></p>
            <p><strong>Name:</strong> <span id="displayName">Loading...</span></p>
            <p><strong>Phone Number:</strong> <span id="displayPhone">Loading...</span></p>
            <p><strong>Email:</strong> <span id="displayEmail">Loading...</span>
              <span id="emailVerified" style="font-size:0.9rem;margin-left:8px;color:#aaa;">(checking...)</span></p>
          </div>
        </section>
      `;

      try {
        const user = await userManager.getUser();

        document.getElementById("displayUsername").textContent = user?.profile?.preferred_username || user?.profile?.username || "(Not available)";
        document.getElementById("displayName").textContent = user?.profile?.name || "(Not provided)";
        document.getElementById("displayPhone").textContent = user?.profile?.phone_number || "(Not provided)";
        document.getElementById("displayEmail").textContent = user?.profile?.email || "(Not provided)";

        if (user?.profile?.email_verified === true || user?.profile?.email_verified === "true") {
          document.getElementById("emailVerified").textContent = "(verified)";
          document.getElementById("emailVerified").style.color = "lightgreen";
        } else {
          document.getElementById("emailVerified").textContent = "(unverified)";
          document.getElementById("emailVerified").style.color = "orange";
        }
      } catch (err) {
        console.error("Error loading user info:", err);
        document.querySelector("section").innerHTML = "<p style='color:red;'>Failed to load user data.</p>";
      }
    });

    // --- DASHBOARD BUTTON (reload main view) ---
    document.getElementById("dashboardBtn").addEventListener("click", () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>Dashboard</h1>
        <p class="lead">Explore and manage your investments — your personalized ETF hub.</p>
        <section class="grid">
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Your ETFs</h5>
          </div>
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Discover</h5>
          </div>
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Analytics</h5>
          </div>
          <div class="cell">
            <div class="square">${"<div></div>".repeat(9)}</div>
            <h5>Performance</h5>
          </div>
        </section>
      `;
    });

    // --- SIGN OUT ---
    document.getElementById("signOut").addEventListener("click", async () => {
      try {
        const user = await userManager.getUser();
        const clientId = "2l15ru0njbo72tv2skuceokjf2";
        const logoutUri = "https://bullride.us";
        const logoutUrl = `https://auth.bullride.us/logout?client_id=${clientId}&logout_uri=${encodeURIComponent(logoutUri)}`;
        if (user) await userManager.removeUser();
        window.location.href = logoutUrl;
      } catch {
        window.location.href = "https://bullride.us";
      }
    });

    // --- MY CREATIONS PAGE ---
    document.getElementById("creationsBtn").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>My Creations</h1>
        <p class="lead">Baskets you've built and shared with the community.</p>

        <section id="basketsGrid"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem;">
          <p>Loading baskets...</p>
        </section>
      `;

      const grid = document.getElementById("basketsGrid");

      try {
        const user = await userManager.getUser();
        const email = user?.profile?.email;
        const res = await fetch(`${API_BASE}/api/baskets/user?email=${encodeURIComponent(email)}`);
        const baskets = await res.json();

        grid.innerHTML = "";

        // Show user's baskets if any
        if (baskets.length > 0) {
          baskets.forEach(b => {
            const card = document.createElement("div");
            card.style.cssText = `
              background:rgba(255,255,255,0.05);
              padding:1.5rem;
              border-radius:12px;
              border:1px solid rgba(255,255,255,0.1);
              text-align:center;
            `;
            card.innerHTML = `
              <h3>${b.name}</h3>
              <p>${b.stocks.length} stock${b.stocks.length !== 1 ? "s" : ""}</p>
              <button style="margin-top:1rem;padding:0.6rem 1rem;border:none;
                border-radius:6px;background:#fff;color:#000;cursor:pointer;">
                Edit Basket
              </button>
            `;
            grid.appendChild(card);
          });
        } else {
          grid.innerHTML = "<p style='opacity:0.8;'>You haven't created any baskets yet.</p>";
        }

        // Always add the “Create New Basket” button
        const create = document.createElement("div");
        create.style.cssText = `
          display:flex;align-items:center;justify-content:center;
          border:2px dashed rgba(255,255,255,0.3);
          border-radius:12px;
          cursor:pointer;transition:all 0.3s ease;height:150px;
        `;
        create.innerHTML = `<span style="font-size:1.2rem;opacity:0.8;">+ Create New Basket</span>`;
        grid.appendChild(create);

        // Handle click → open a simple input prompt and create basket
        create.addEventListener("click", async () => {
          const name = prompt("Name your new basket:");
          if (!name) return;
          const stockSymbol = prompt("Add at least one stock symbol (e.g., AAPL):");
          if (!stockSymbol) return;

          const payload = {
            userEmail: email,
            name,
            stocks: [{ symbol: stockSymbol, shares: 1, price: 0 }]
          };

          try {
            const res = await fetch(`${API_BASE}/api/baskets/create`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            alert("Basket created successfully!");
            console.log("Created:", data);
            document.getElementById("creationsBtn").click(); // reload list
          } catch (err) {
            console.error("Error creating basket:", err);
            alert("Failed to create basket. Check console for details.");
          }
        });
      } catch (err) {
        console.error("Error loading baskets:", err);
        grid.innerHTML = "<p style='color:red;'>Failed to load baskets.</p>";
      }
    });


    // --- MY INVESTMENTS PAGE ---
    document.getElementById("investmentsBtn").addEventListener("click", async () => {
      const main = document.querySelector("main");
      main.innerHTML = `
        <h1>My Investments</h1>
        <p class="lead">Baskets you've purchased or invested in — your active portfolio overview.</p>

        <section style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:2rem;">
          <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <h3>AI Innovators Fund</h3>
            <p>Created by @sophia</p>
            <p style="margin-top:0.5rem;">Return: <strong style="color:lightgreen;">+8.7%</strong></p>
            <button style="margin-top:1rem;padding:0.6rem 1rem;border:none;border-radius:6px;background:#fff;color:#000;cursor:pointer;">View Details</button>
          </div>

          <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <h3>Green Energy Growth</h3>
            <p>Created by You</p>
            <p style="margin-top:0.5rem;">Return: <strong style="color:lightgreen;">+2.1%</strong></p>
            <button style="margin-top:1rem;padding:0.6rem 1rem;border:none;border-radius:6px;background:#fff;color:#000;cursor:pointer;">View Details</button>
          </div>

          <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            <h3>Tech Titans Basket</h3>
            <p>Created by You</p>
            <p style="margin-top:0.5rem;">Return: <strong style="color:red;">-1.4%</strong></p>
            <button style="margin-top:1rem;padding:0.6rem 1rem;border:none;border-radius:6px;background:#fff;color:#000;cursor:pointer;">View Details</button>
          </div>
        </section>
      `;
    });

    // --- ADMIN PANEL BUTTON (redirect to admin page) ---
    document.getElementById("adminBtn").addEventListener("click", () => {
      window.location.href = "https://bullride.us/bradminlc_1.html";
    });


  </script>
</body>
</html>
